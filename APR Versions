let
  Site = "https://usps365.sharepoint.com/sites/FOSAppResultsWarehouse",
  Url  = Site & "/_api/web/lists/GetByTitle('APR Call')/items" &
        "?$select=Id," &
        "Versions/VersionId,Versions/VersionLabel,Versions/Modified," &
        "Versions/Editor/Title,Versions/Editor/EMail," &
        "Versions/FieldValuesAsText" &
        "&$expand=Versions,Versions/Editor" &
        "&$format=application/json;odata=minimalmetadata",

  Src  = OData.Feed(Url, null, [Implementation="2.0"]),
  Keep = Table.SelectColumns(Src, {"Id","Versions"}),

  V1 = Table.ExpandTableColumn(Keep, "Versions",
        {"VersionId","VersionLabel","Modified","Editor","FieldValuesAsText"},
        {"VersionId","VersionLabel","VersionModified","EditorRec","FieldsRec"}),

  V2 = Table.ExpandRecordColumn(V1, "EditorRec", {"Title","EMail"}, {"EditorName","EditorEmail"}),

  V3 = Table.ExpandRecordColumn(V2, "FieldsRec",
        {"DateofCall","DateofFollowUp","DueDate","Area","District","Office","WhoSpoke?","PersonSpeakingforSite",
         "Commitments","APRIndicator","ServiceIndicator","ServiceIndicato","StatusNew","NEW_LastEscalated","NEW_EscalationTier","MPOO"},
        {"DateofCall","DateofFollowUp","DueDate","Area","District","Office","WhoSpoke?","PersonSpeakingforSite",
         "Commitments","APRIndicator","ServiceIndicator","ServiceIndicato","StatusNew","NEW_LastEscalated","NEW_EscalationTier","MPOO"}),

  Ren = Table.RenameColumns(V3,{
        {"DateofCall","DateOfCall"},{"DateofFollowUp","DateOfFollowUp"},
        {"DueDate","CommitmentDate"},{"StatusNew","Status_Switch"},
        {"NEW_LastEscalated","LastEscalated"},{"NEW_EscalationTier","Tier"},{"MPOO","MPOOView"}
      }, MissingField.Ignore),

  AddUnit = Table.AddColumn(Ren, "Unit", each if [Office] <> null then [Office] else null),
  AddWho  = Table.AddColumn(AddUnit, "WhoSpoke",
              each let w = try Record.Field(_, "WhoSpoke?") otherwise null,
                       p = try [PersonSpeakingforSite] otherwise null
                   in if w <> null and Text.From(w) <> "" then w else p),
  AddSvc  = Table.AddColumn(AddWho, "ServiceIndicator_std",
              each if Text.FromNullable([ServiceIndicator]) <> "" then [ServiceIndicator]
                   else if Text.FromNullable([ServiceIndicato]) <> "" then [ServiceIndicato] else null),
  AddInd  = Table.AddColumn(AddSvc, "IndicatorUnified",
              each if Text.FromNullable([APRIndicator]) <> "" then [APRIndicator] else null),

  Types = Table.TransformColumnTypes(AddInd,{
        {"VersionModified", type datetimezone},
        {"DateOfCall", type datetime},{"CommitmentDate", type datetime},{"DateOfFollowUp", type datetime}
      }, "en-US"),

  Out = Table.SelectColumns(Types,{
        "Id","DateOfCall","CommitmentDate","DateOfFollowUp",
        "Area","District","Unit","WhoSpoke","Commitments",
        "IndicatorUnified","ServiceIndicator_std",
        "Tier","LastEscalated","Status_Switch","MPOOView",
        "VersionId","VersionLabel","VersionModified","EditorName","EditorEmail"
      }, MissingField.Ignore),

  Final = Table.RenameColumns(Out, {{"ServiceIndicator_std","ServiceIndicator"}})
in
  Final
